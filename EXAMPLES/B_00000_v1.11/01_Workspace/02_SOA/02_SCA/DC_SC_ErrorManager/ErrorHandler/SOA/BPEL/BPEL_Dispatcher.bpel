<?xml version = "1.0" encoding = "UTF-8" ?>
<!--
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  Oracle JDeveloper BPEL Designer 
  
  Created: Wed Feb 10 15:51:22 ART 2016
  Author:  zacarias.piscopo
  Type: BPEL 2.0 Process
  Purpose: One Way BPEL Process
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
-->
<process name="BPEL_Dispatcher"
               targetNamespace="http://xmlns.oracle.com/DC_SC_ErrorManager/ErrorHandler/BPEL_Dispatcher"
               xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
               xmlns:client="http://xmlns.oracle.com/DC_SC_ErrorManager/ErrorHandler/BPEL_Dispatcher"
               xmlns:ora="http://schemas.oracle.com/xpath/extension"
               xmlns:bpelx="http://schemas.oracle.com/bpel/extension"
               xmlns:ui="http://xmlns.oracle.com/soa/designer"
               xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:ns1="http://xmlns.oracle.com/pcbpel/adapter/db/DC_SC_ErrorManager/ErrorHandler/ESB_ERROR_DISPATCHER_pull"
         xmlns:oraext="http://www.oracle.com/XSL/Transform/java/oracle.tip.pc.services.functions.ExtFunc"
         xmlns:bpm="http://xmlns.oracle.com/bpmn20/extensions"
         xmlns:xp20="http://www.oracle.com/XSL/Transform/java/oracle.tip.pc.services.functions.Xpath20"
         xmlns:ess="http://xmlns.oracle.com/scheduler" xmlns:hwf="http://xmlns.oracle.com/bpel/workflow/xpath"
         xmlns:xref="http://www.oracle.com/XSL/Transform/java/oracle.tip.xref.xpath.XRefXPathFunctions"
         xmlns:ns2="http://xmlns.oracle.com/pcbpel/adapter/db/top/ESB_ERROR_DISPATCHER_pull"
         xmlns:dvm="http://www.oracle.com/XSL/Transform/java/oracle.tip.dvm.LookupValue"
         xmlns:bpws="http://schemas.xmlsoap.org/ws/2003/03/business-process/"
         xmlns:xdk="http://schemas.oracle.com/bpel/extension/xpath/function/xdk"
         xmlns:ids="http://xmlns.oracle.com/bpel/services/IdentityService/xpath"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns:ldap="http://schemas.oracle.com/xpath/extension/ldap"
         xmlns:ns3="http://www.entel.cl/ESO/NotificationTreatment/v1"
         xmlns:ns4="http://www.entel.cl/ESO/ErrorTreatment/v1"
         xmlns:ns5="http://xmlns.oracle.com/DC_SC_ErrorManager/RegisterRetry/RegisterRetryBPEL"
         xmlns:ns6="http://www.entel.cl/ESO/RetryTreatment/v1"
         xmlns:ns8="http://www.entel.cl/ESO/Treatment/Generic/v1"
         xmlns:ns7="http://xmlns.oracle.com/pcbpel/adapter/db/DC_SC_ErrorManager/ErrorHandler/Call_to_SP_ERROR_DISPATCHER_SET_STATE"
         xmlns:ns9="http://xmlns.oracle.com/pcbpel/adapter/db/sp/Call_to_SP_ERROR_DISPATCHER_SET_STATE"
         xmlns:ns10="http://www.entel.cl/ESO/ErrorTreatment/Generic/v1">
  <!-- 
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      PARTNERLINKS                                                      
      List of services participating in this BPEL process               
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->
  <import namespace="http://www.entel.cl/ESO/Treatment/Generic/v1"
          location="../WSDLs/ErrorDispatcherTreatment.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
  <import namespace="http://www.entel.cl/ESO/NotificationTreatment/v1" location="oramds:/apps/Commons/DC_SC_ErrorManager/ErrorHospital/WSDL/NotificationTreatment.wsdl"
          importType="http://schemas.xmlsoap.org/wsdl/"/>
  <import namespace="http://xmlns.oracle.com/pcbpel/adapter/db/DC_SC_ErrorManager/ErrorHandler/ESB_ERROR_DISPATCHER_pull"
          location="../WSDLs/ESB_ERROR_DISPATCHER_pull.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"
          ui:processWSDL="true"/>
  <partnerLinks>
    <!-- 
      The 'client' role represents the requester of this service. It is 
      used for callback. The location and correlation information associated
      with the client role are automatically set using WS-Addressing.
    -->
    <partnerLink name="ESB_ERROR_DISPATCHER_pull" partnerLinkType="ns1:ESB_ERROR_DISPATCHER_pull_plt"
                 myRole="ESB_ERROR_DISPATCHER_pull_role"/>
    <partnerLink name="Mediator_Dispatcher_DynamicRouting.Mediator_Dispatcher_DynamicRouting"
                 partnerLinkType="ns8:Mediator_Dispatcher_DynamicRouting.Mediator_Dispatcher_DynamicRouting"
                 partnerRole="Treatment_PortType"/>
  </partnerLinks>

  <!-- 
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      VARIABLES                                                        
      List of messages and XML documents used within this BPEL process 
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->
  <variables>
    <!-- Reference to the message passed as input during initiation -->
    <variable name="inputVariable" messageType="ns1:EsbErrorDispatcherCollection_msg"/>

  </variables>
  <faultHandlers>
    <catchAll>
      <throw name="ThrowRollBack" faultName="bpelx:rollback"/>
    </catchAll>
  </faultHandlers>
  <!-- 
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
     ORCHESTRATION LOGIC                                               
     Set of activities coordinating the flow of messages across the    
     services integrated within this business process                  
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->
  <sequence name="main">

    <!-- Receive input from requestor. (Note: This maps to operation defined in BPEL_Dispatcher.wsdl) -->
    <receive name="receiveInput" partnerLink="ESB_ERROR_DISPATCHER_pull" portType="ns1:ESB_ERROR_DISPATCHER_pull_ptt"
             operation="receive" variable="inputVariable" createInstance="yes"/>
    <forEach parallel="no" counterName="index" name="ForEach_Row_ERROR_Dispatcher">
      <startCounterValue>1</startCounterValue>
      <finalCounterValue>count($inputVariable.EsbErrorDispatcherCollection/ns2:EsbErrorDispatcher)</finalCounterValue>
      <scope name="Scope1">
        <variables>
          <variable name="Req_DispatcherMediator_IN" messageType="ns8:Treatment"/>
        </variables>
        <sequence name="Sequence4">
          <sequence name="Sequence1">
            <assign name="Assign_Req_Mediator_Dispatcher">
              <copy>
                <from>$inputVariable.EsbErrorDispatcherCollection/ns2:EsbErrorDispatcher[$index]/ns2:id</from>
                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$Req_DispatcherMediator_IN.In/ns10:Treatment_Id</to>
              </copy>
              <copy>
                <from>$inputVariable.EsbErrorDispatcherCollection/ns2:EsbErrorDispatcher[$index]/ns2:treatmentId</from>
                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$Req_DispatcherMediator_IN.In/ns10:Error_Treatment_Id</to>
              </copy>
            </assign>
          </sequence>
          <invoke name="InvokeMediator"
                  partnerLink="Mediator_Dispatcher_DynamicRouting.Mediator_Dispatcher_DynamicRouting"
                  portType="ns8:Treatment_PortType" operation="process"
                  inputVariable="Req_DispatcherMediator_IN" bpelx:invokeAsDetail="no"/>
        </sequence>
      </scope>
    </forEach>
  </sequence>
</process>